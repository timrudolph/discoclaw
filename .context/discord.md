# discord.md — Discord Behavior & Routing

## Access Control
- `DISCORD_ALLOW_USER_IDS` is the primary gate.
- Fail closed: if the allowlist is empty, Discoclaw responds to nobody.
- Optional: `DISCORD_CHANNEL_IDS` restricts the bot to specific guild channels (DMs are still allowed).

## Channel Context (Token-Efficient)
Discoclaw can link a per-channel context file into the runtime prompt (instead of inlining it) to keep initial context small.

Layout (under `$DISCOCLAW_CONTENT_DIR` or `$DISCOCLAW_DATA_DIR/content`):
- `discord/DISCORD.md` (index: channel -> id -> context file)
- `discord/channels/*.md` (per-channel context modules)
- `discord/channels/_default.md` (fallback for unknown channels)
- `discord/channels/dm.md` (DM fallback)

Behavior:
- For each message, Discoclaw tells the runtime to `Read` the relevant channel context file before responding.
- For threads, the parent channel context applies.

Strict mode:
- `DISCORD_REQUIRE_CHANNEL_CONTEXT=1` (default): the bot requires a per-channel context file.
- `DISCORD_AUTO_INDEX_CHANNEL_CONTEXT=1` (default): when a message arrives for a new channel, Discoclaw appends it to `discord/DISCORD.md` and creates a blank stub file.

Thread auto-join:
- `DISCORD_AUTO_JOIN_THREADS=0` (default): best-effort auto-join threads so the bot can respond inside them. Private threads still require adding the bot manually.

## Conversation History & Memory
When `DISCOCLAW_MESSAGE_HISTORY_BUDGET` > 0 (default: `3000`), Discoclaw fetches recent messages from the Discord channel and includes them in the prompt as conversation context. This allows Claude to maintain conversational context across messages without relying on CLI session persistence. The char budget caps the total history size; messages are selected newest-first so the most relevant context is preserved. Bot responses are truncated when necessary to fit the budget.

### Rolling Summaries
When `DISCOCLAW_SUMMARY_ENABLED=1` (default), Discoclaw maintains a rolling conversation summary per session key, generated by Haiku every N turns (`DISCOCLAW_SUMMARY_EVERY_N_TURNS`, default 5). The summary is a compressed narrative of earlier conversation — decisions, preferences, current focus — kept under `DISCOCLAW_SUMMARY_MAX_CHARS` characters.

Summaries are stored on disk at `data/memory/rolling/<safe-session-key>.json` and injected into the prompt between context files and recent conversation as a "Conversation memory" section. When recent messages and the summary conflict, the recent messages take precedence (the summary is lossy). Summary generation is best-effort: failures are logged and do not block responding.

### Durable Memory
When `DISCOCLAW_DURABLE_MEMORY_ENABLED=1` (default), Discoclaw maintains persistent per-user memory that survives across channels and sessions. Items are stored at `data/memory/durable/<user-id>.json` and include facts, preferences, projects, and other user-specific notes.

Active durable items are injected into the prompt between context files and conversation memory, sorted by most recently updated, capped by `DISCOCLAW_DURABLE_INJECT_MAX_CHARS` (default 2000). Each user can store up to `DISCOCLAW_DURABLE_MAX_ITEMS` (default 200) items.

When `DISCOCLAW_MEMORY_COMMANDS_ENABLED=1` (default), users can manage their durable memory via commands:
- `!memory` or `!memory show` — display active durable items and rolling summary
- `!memory remember <text>` — store a new fact
- `!memory forget <text>` — deprecate matching items (requires 60% text-length match)
- `!memory reset rolling` — clear the rolling summary for the current session

Memory commands are intercepted before runtime invocation and do not consume API tokens.

## Session Keys
- DM: `discord:dm:<authorId>`
- Thread: `discord:thread:<threadId>` (if the incoming channel is a thread)
- Channel: `discord:channel:<channelId>`

These session keys map to persisted UUIDs via `data/sessions.json`.

## Concurrency (Single Flight)
- Discoclaw serializes processing per session key to avoid interleaving tool runs/context.
- Implementation: `src/group-queue.ts`

## Output Constraints
- Discord has a ~2000 char limit per message.
- Discoclaw chunks long replies and attempts to keep fenced code blocks renderable across splits.

## Discord Actions
When `DISCOCLAW_DISCORD_ACTIONS=1` (master switch), Claude can perform Discord server actions by emitting `<discord-action>` blocks in its response. After the runtime completes, Discoclaw parses these blocks, executes them via discord.js, strips the blocks from the displayed message, and appends results.

Each action category has its own flag (only active when the master switch is `1`):

| Flag | Default | Actions |
|------|---------|---------|
| `DISCOCLAW_DISCORD_ACTIONS_CHANNELS` | `1` | channelCreate, channelEdit, channelDelete, channelList, channelInfo, categoryCreate, threadListArchived |
| `DISCOCLAW_DISCORD_ACTIONS_MESSAGING` | `0` | sendMessage, react, readMessages, fetchMessage, editMessage, deleteMessage, threadCreate, pinMessage, unpinMessage, listPins |
| `DISCOCLAW_DISCORD_ACTIONS_GUILD` | `0` | memberInfo, roleInfo, roleAdd, roleRemove, searchMessages, eventList, eventCreate |
| `DISCOCLAW_DISCORD_ACTIONS_MODERATION` | `0` | timeout, kick, ban |
| `DISCOCLAW_DISCORD_ACTIONS_POLLS` | `0` | poll |
| `DISCOCLAW_DISCORD_ACTIONS_BEADS` | `0` | beadCreate, beadUpdate, beadClose, beadShow, beadList, beadSync |

Auto-follow-up: When query actions (channelList, channelInfo, threadListArchived, readMessages, fetchMessage, listPins, memberInfo, roleInfo, searchMessages, eventList, beadList, beadShow) succeed, Discoclaw automatically re-invokes Claude with the results. This allows Claude to reason about query results without requiring the user to send a follow-up message. Controlled by `DISCOCLAW_ACTION_FOLLOWUP_DEPTH` (default `3`, `0` disables). Mutation-only responses do not trigger follow-ups. Trivially short follow-up responses (<50 chars with no actions) are suppressed.

Requirements:
- The bot needs appropriate permissions in the server (Manage Channels, Manage Roles, Moderate Members, etc.) depending on the actions used. These are server-level role permissions, not Developer Portal settings.
- Only works in guild channels (not DMs).
- Master switch defaults to off (`0`). Only allowlisted users can trigger actions.
- Destructive actions (delete, kick, ban, timeout) prompt Claude to confirm with the user first.
- If actions fail with "Missing Permissions", the bot's role lacks the required permission.

## Status Channel
When `DISCOCLAW_STATUS_CHANNEL` is set to a channel name or ID, Discoclaw posts colored embeds on key events:
- **Bot Online** (green) — posted after the `ready` event fires
- **Bot Offline** (gray) — posted on SIGTERM/SIGINT (best-effort)
- **Runtime Error** (red) — Claude CLI returned an error or timed out
- **Handler Failure** (red) — uncaught exception in message processing
- **Action Failed** (orange) — a Discord action returned `{ ok: false }`

Fail-open: if the channel is not found or the env var is unset, the bot works normally with no status posts. Errors posting to the status channel are caught and logged, never crashing the bot.

Implementation: `src/discord/status-channel.ts`

## Cron (Scheduled Tasks)
When `DISCOCLAW_CRON_ENABLED=1` and `DISCOCLAW_CRON_FORUM` is set to a forum channel name or ID, Discoclaw runs a forum-based cron subsystem. Each forum thread is a cron job: the thread name is the job name, and the starter message is a natural-language definition that gets parsed by AI into a schedule, timezone, target channel, and prompt.

Creating a cron: create a thread in the forum. The starter message should describe the schedule, target channel, and what to do (e.g., "Every weekday at 7am Pacific, check the weather for Portland OR and post a brief summary to #general."). The bot reacts with a checkmark and replies with the parsed schedule.

Managing crons:
- **Disable:** Archive the thread. The bot stops scheduling.
- **Enable:** Unarchive the thread. The bot re-parses and resumes.
- **Edit:** Edit the starter message. The bot re-parses on the next `messageUpdate`.
- **Delete:** Delete the thread. The bot removes the job.

Archive vs delete: archiving a thread is reversible (sets the archived flag; thread still exists and can be unarchived). Deleting a thread is permanent (thread and its messages are gone). The `cronDelete` action archives the thread — it does not delete it — so history is preserved and the cron can be restored by unarchiving.

Cron responses are posted to the target channel only (threads stay clean as config). Discord actions are supported in cron responses if the master switch is enabled. Failures are posted to the status channel.

Overlap protection: if a previous run for the same job is still active, the next tick is skipped.

Implementation: `src/cron/`

## Beads (Task Tracking)
When `DISCOCLAW_BEADS_ENABLED=1` and `DISCOCLAW_BEADS_FORUM` is set to a forum channel name or ID, Discoclaw integrates with the `bd` CLI (beads issue tracker) to sync tasks to Discord forum threads.

Two paths produce the same Discord state:

**CLI path** (developer at terminal): `scripts/beads/bd-wrapper.sh` intercepts `bd create/close/update/q` and fires hook scripts that create/update/archive Discord forum threads via curl.

**Bot path** (AI via Discord action): `<discord-action>{"type":"beadCreate",...}` blocks are parsed and executed by `actions-beads.ts`, which calls `bd` via `bd-cli.ts` and syncs threads via `discord-sync.ts` (discord.js).

Both use the `bd` binary for data storage and produce identical Discord thread state: emoji-prefixed thread names, auto-tagged forum tags, and archive-on-close behavior.

Bead actions (requires `DISCOCLAW_DISCORD_ACTIONS=1` and `DISCOCLAW_DISCORD_ACTIONS_BEADS=1`):
- `beadCreate` — create a bead + forum thread (auto-tagged if enabled)
- `beadUpdate` — update bead fields + sync thread name/emoji
- `beadClose` — close bead + post summary + archive thread
- `beadShow` — show bead details
- `beadList` — list beads with optional status/label filters
- `beadSync` — run full 4-phase safety-net sync

Data import: point `DISCOCLAW_BEADS_CWD` at an existing beads workspace (e.g., `~/Dropbox/weston`). Existing beads and their `external_ref` fields (thread IDs) work as-is since both bots share the same Discord guild.

Implementation: `src/beads/`, `src/discord/actions-beads.ts`, `scripts/beads/`

## Group CWD Mode
If `USE_GROUP_DIR_CWD=1`:
- CWD becomes `groups/<sessionKey>/` for that Discord context.
- The main workspace (`WORKSPACE_CWD`) is added via `--add-dir` so tools can still read/write it.
- Discoclaw bootstraps `groups/<sessionKey>/CLAUDE.md` on first use.
