# discord.md — Discord Behavior & Routing

## Access Control
- `DISCORD_ALLOW_USER_IDS` is the primary gate.
- Fail closed: if the allowlist is empty, Discoclaw responds to nobody.
- Optional: `DISCORD_CHANNEL_IDS` restricts the bot to specific guild channels (DMs are still allowed).

## Channel Context (Token-Efficient)
Discoclaw can link a per-channel context file into the runtime prompt (instead of inlining it) to keep initial context small.

Layout (under `$DISCOCLAW_CONTENT_DIR` or `$DISCOCLAW_DATA_DIR/content`):
- `discord/DISCORD.md` (index: channel -> id -> context file)
- `discord/channels/*.md` (per-channel context modules)
- `discord/channels/_default.md` (fallback for unknown channels)
- `discord/channels/dm.md` (DM fallback)

Behavior:
- For each message, Discoclaw tells the runtime to `Read` the relevant channel context file before responding.
- For threads, the parent channel context applies.

Strict mode:
- `DISCORD_REQUIRE_CHANNEL_CONTEXT=1` (default): the bot requires a per-channel context file.
- `DISCORD_AUTO_INDEX_CHANNEL_CONTEXT=1` (default): when a message arrives for a new channel, Discoclaw appends it to `discord/DISCORD.md` and creates a blank stub file.

Thread auto-join:
- `DISCORD_AUTO_JOIN_THREADS=0` (default): best-effort auto-join threads so the bot can respond inside them. Private threads still require adding the bot manually.

## Conversation History & Memory
When `DISCOCLAW_MESSAGE_HISTORY_BUDGET` > 0 (default: `3000`), Discoclaw fetches recent messages from the Discord channel and includes them in the prompt as conversation context. This allows Claude to maintain conversational context across messages without relying on CLI session persistence. The char budget caps the total history size; messages are selected newest-first so the most relevant context is preserved. Bot responses are truncated when necessary to fit the budget.

### Rolling Summaries
When `DISCOCLAW_SUMMARY_ENABLED=1` (default), Discoclaw maintains a rolling conversation summary per session key, generated by Haiku every N turns (`DISCOCLAW_SUMMARY_EVERY_N_TURNS`, default 5). The summary is a compressed narrative of earlier conversation — decisions, preferences, current focus — kept under `DISCOCLAW_SUMMARY_MAX_CHARS` characters.

Summaries are stored on disk at `data/memory/rolling/<safe-session-key>.json` and injected into the prompt between context files and recent conversation as a "Conversation memory" section. When recent messages and the summary conflict, the recent messages take precedence (the summary is lossy). Summary generation is best-effort: failures are logged and do not block responding.

### Durable Memory
When `DISCOCLAW_DURABLE_MEMORY_ENABLED=1` (default), Discoclaw maintains persistent per-user memory that survives across channels and sessions. Items are stored at `data/memory/durable/<user-id>.json` and include facts, preferences, projects, and other user-specific notes.

Active durable items are injected into the prompt between context files and conversation memory, sorted by most recently updated, capped by `DISCOCLAW_DURABLE_INJECT_MAX_CHARS` (default 2000). Each user can store up to `DISCOCLAW_DURABLE_MAX_ITEMS` (default 200) items.

When `DISCOCLAW_MEMORY_COMMANDS_ENABLED=1` (default), users can manage their durable memory via commands:
- `!memory` or `!memory show` — display active durable items and rolling summary
- `!memory remember <text>` — store a new fact
- `!memory forget <text>` — deprecate matching items (requires 60% text-length match)
- `!memory reset rolling` — clear the rolling summary for the current session

Memory commands are intercepted before runtime invocation and do not consume API tokens.

## Session Keys
- DM: `discord:dm:<authorId>`
- Thread: `discord:thread:<threadId>` (if the incoming channel is a thread)
- Channel: `discord:channel:<channelId>`

These session keys map to persisted UUIDs via `data/sessions.json`.

## Concurrency (Single Flight)
- Discoclaw serializes processing per session key to avoid interleaving tool runs/context.
- Implementation: `src/group-queue.ts`

## Output Constraints
- Discord has a ~2000 char limit per message.
- Discoclaw chunks long replies and attempts to keep fenced code blocks renderable across splits.

## Discord Actions
When `DISCOCLAW_DISCORD_ACTIONS=1`, Claude can perform Discord server actions by emitting `<discord-action>` blocks in its response. After the runtime completes, Discoclaw parses these blocks, executes them via discord.js, strips the blocks from the displayed message, and appends results.

Available actions:
- `channelCreate` — Create a text channel (optionally under a category).
- `channelList` — List all channels grouped by category.

Requirements:
- The bot needs **Manage Channels** permission in the server (server-level role permission, not a Developer Portal setting).
- This means the bot must be invited with at least the `moderator` permission profile, or have Manage Channels granted manually via Server Settings → Roles.
- Only works in guild channels (not DMs).
- Default off (`0`). Only allowlisted users can trigger actions.
- If actions fail with "Missing Permissions", the bot's role lacks Manage Channels.

## Group CWD Mode
If `USE_GROUP_DIR_CWD=1`:
- CWD becomes `groups/<sessionKey>/` for that Discord context.
- The main workspace (`WORKSPACE_CWD`) is added via `--add-dir` so tools can still read/write it.
- Discoclaw bootstraps `groups/<sessionKey>/CLAUDE.md` on first use.
